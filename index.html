<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi de Production</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  direction:rtl;
  font-family:Arial;
  background:#ff9800;
  padding:20px;
  text-align:center;
}
.header-container {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 20px;
}
.header-item {
  background:#fff3e0;
  padding: 10px 15px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: background-color 0.2s, transform 0.1s;
  border: 2px solid #000000;
  min-width: 150px;
  text-align: center;
  position: relative;
}
.header-item:hover {
  background-color: #ffcc80;
  transform: translateY(-2px);
}
.header-item .label {
  font-size: 12px;
  color: #000000;
  margin-bottom: 5px;
}
.header-item .value {
  font-size: 16px;
  font-weight: bold;
  color: #000000;
}
.header-item.auto-mode {
  border-color: #4CAF50;
  background: #e8f5e9;
}
.header-item.manual-mode {
  border-color: #2196F3;
  background: #e3f2fd;
}
.auto-mode-indicator {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #4CAF50;
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.total-counter{
  font-size:28px;
  font-weight:bold;
  margin:20px auto;
  color: #000000;
  background: #fff3e0;
  padding: 15px;
  border-radius: 10px;
  border: 2px solid #000000;
  display: inline-block;
  width: 90%;
  max-width: 800px;
  box-sizing: border-box;
}
.buttons-container {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  margin: 20px 0;
}
.nav-button{
  background:#000000;
  color:white;
  border:none;
  padding:10px 18px;
  font-size:15px;
  cursor:pointer;
  border-radius:4px;
  border: 2px solid white;
  min-width: 150px;
}
.nav-button:hover{
  background:#333333;
}
.nav-button.auto-mode-btn {
  background: #4CAF50;
  color: white;
  border: 2px solid #4CAF50;
}
.nav-button.manual-mode-btn {
  background: #2196F3;
  color: white;
  border: 2px solid #2196F3;
}
.nav-button.cancel-btn {
  background: #f44336;
  color: white;
  border: 2px solid #f44336;
}
.nav-button.apply-btn {
  background: #4CAF50;
  color: white;
  border: 2px solid #4CAF50;
}
table{
  width:100%;
  max-width:1000px;
  margin:auto;
  border-collapse:collapse;
  background:#fff3e0;
  border: 2px solid #000000;
}
th,td{
  border:1px solid #000000;
  padding:10px;
  white-space:pre-line;
}
th{
  background:#000000;
  color:white;
}
td{
  background:#fff3e0;
}
h2{
  color: #000000;
  margin-bottom: 20px;
  background: #fff3e0;
  padding: 15px;
  border-radius: 10px;
  border: 2px solid #000000;
  display: inline-block;
}
.shift-nav-buttons {
  margin: 15px 0;
  display: flex;
  justify-content: center;
  gap: 10px;
}
.shift-nav-buttons .nav-button {
  background: #000000;
  color: white;
  border: 2px solid white;
}
.shift-nav-buttons .nav-button:hover {
  background: #333333;
}
.shift-info {
  background: #fff3e0;
  padding: 15px;
  border-radius: 10px;
  border: 2px solid #000000;
  margin: 15px auto;
  display: block;
  font-weight: bold;
  max-width: 1000px;
  text-align: center;
}
.shift-info strong {
  color: #000000;
}
.shift-info small {
  display: block;
  margin-top: 8px;
  color: #666;
}
.edit-modal-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 20px;
  flex-wrap: wrap;
}

/* Indicateur de pri√®re */
#prayerIndicator {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #4CAF50, #2E7D32);
  color: white;
  padding: 12px 24px;
  border-radius: 25px;
  font-weight: bold;
  font-size: 16px;
  z-index: 1001;
  box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
  text-align: center;
  border: 2px solid white;
  backdrop-filter: blur(5px);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { transform: translateX(-50%) scale(1); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
  50% { transform: translateX(-50%) scale(1.05); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6); }
  100% { transform: translateX(-50%) scale(1); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
}

/* Am√©lioration de l'affichage des shifts pr√©c√©dents */
.previous-shift-item {
  transition: all 0.3s ease;
  border-left: 4px solid #ff9800;
  padding: 10px;
  margin-bottom: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  cursor: pointer;
}

.previous-shift-item:hover {
  transform: translateX(-5px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.previous-shift-item.team-A {
  border-left-color: #2196F3;
}

.previous-shift-item.team-B {
  border-left-color: #4CAF50;
}
</style>
</head>

<body>

<h2> SUIVI PRODUCTION MOBILISE</h2>

<div class="header-container">
  <div class="header-item auto-mode" id="weekItem" onclick="openEditModal('week')">
    <div class="label">Semaine</div>
    <div class="value" id="weekValue">0</div>
    <div class="auto-mode-indicator">A</div>
  </div>
  <div class="header-item auto-mode" id="dateItem" onclick="openEditModal('date')">
    <div class="label">Date</div>
    <div class="value" id="dateValue">00/00/0000</div>
    <div class="auto-mode-indicator">A</div>
  </div>
  <div class="header-item auto-mode" id="timeItem" onclick="openEditModal('time')">
    <div class="label">Heure</div>
    <div class="value" id="timeValue">00:00:00</div>
    <div class="auto-mode-indicator">A</div>
  </div>
  <div class="header-item auto-mode" id="teamItem" onclick="openEditModal('team')">
    <div class="label">√âquipe</div>
    <div class="value" id="teamValue">A</div>
    <div class="auto-mode-indicator">A</div>
  </div>
  <div class="header-item auto-mode" id="shiftItem" onclick="openEditModal('shift')">
    <div class="label">Shift</div>
    <div class="value" id="shiftValue">Matin</div>
    <div class="auto-mode-indicator">A</div>
  </div>
  <div class="header-item auto-mode" id="workerItem" onclick="openEditModal('worker')">
    <div class="label">OPS</div>
    <div class="value" id="workerValue">Nom</div>
    <div class="auto-mode-indicator">A</div>
  </div>
</div>

<div class="buttons-container">
  <button class="nav-button" onclick="openInput()">‚ûï Ajouter une entr√©e</button>
  <button class="nav-button" onclick="generateFormattedPDF()">üìÑ Exporter PDF </button>
  <button class="nav-button" onclick="exportAndClearVisiblePDF()">üóëÔ∏è Effacer (et PDF )</button>
  <button class="nav-button" onclick="openExcelForm()">üì• Exporter Excel</button>
  <button class="nav-button" onclick="openSearchModal()">üîç Rechercher</button>
  <button class="nav-button" onclick="openPreviousShiftsModal()">üìú Shifts Pr√©c√©dents</button>
</div>

<div class="total-counter">
  Total produits : <span id="totalCount">0</span>
</div>

<table id="productionTable">
<thead>
<tr>
  <th>Heure</th>
  <th>Num√©ro</th>
  <th>Remarque</th>
  <th>Supprimer</th>
</tr>
</thead>
<tbody id="dataTable"></tbody>
</table>

<div id="shiftInfoDisplay" class="shift-info" style="margin-top: 20px; margin-bottom: 20px;">
  Shift: -- | √âquipe: -- | OPS: -- | Date: --
</div>

<div class="shift-nav-buttons">
  <button class="nav-button" onclick="previousShift()">‚¨ÖÔ∏è Shift Pr√©c√©dent</button>
  <button class="nav-button" onclick="endCurrentShift()">üîÑ Terminer Shift Actuel</button>
  <button class="nav-button" onclick="nextShift()">‚û°Ô∏è Shift Suivant</button>
</div>

<!-- Modal Modification de valeur -->
<div id="editModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:1000">
  <div style="background:#fff3e0;padding:25px;border-radius:10px;width:450px;text-align:right;box-shadow:0 4px 20px rgba(0,0,0,0.2);border:2px solid #000000">
    <h3 id="editTitle" style="color:#000000;margin-bottom:20px;text-align:center;">Modifier la valeur</h3>
    
    <div style="margin-bottom:20px;">
      <div style="color:#000000;margin-bottom:8px;font-weight:bold;font-size:14px;">Valeur actuelle:</div>
      <div id="currentValueDisplay" style="background:white;padding:12px;border-radius:4px;border:1px solid #000000;margin-bottom:15px;font-size:16px;font-weight:bold;text-align:center;"></div>
    </div>
    
    <div style="margin-bottom:25px;">
      <div style="color:#000000;margin-bottom:8px;font-weight:bold;font-size:14px;">Nouvelle valeur:</div>
      <input id="editInput" style="width:100%;padding:12px;font-size:16px;border:2px solid #2196F3;border-radius:4px;background:white;text-align:center;" placeholder="Entrez la nouvelle valeur">
    </div>
    
    <div style="margin-bottom:15px;padding:12px;background:#f8f9fa;border-radius:6px;border:1px solid #dee2e6;text-align:center;">
      <div style="color:#666;font-size:12px;">
        <span style="color:#4CAF50;font-weight:bold;">üîÑ A</span> = Automatique | 
        <span style="color:#2196F3;font-weight:bold;">‚úèÔ∏è M</span> = Manuel
      </div>
    </div>
    
    <div class="edit-modal-buttons">
      <button class="nav-button apply-btn manual-mode-btn" onclick="applyChanges('manual')" style="background:#2196F3;color:white;border:2px solid #2196F3">üíæ Enregistrer en Manuel</button>
      <button class="nav-button apply-btn" onclick="applyChanges('auto')" style="background:#4CAF50;color:white;border:2px solid #4CAF50">üíæ Enregistrer en Automatique</button>
      <button class="nav-button auto-mode-btn" onclick="setToAutoMode()" style="background:#4CAF50;color:white;border:2px solid #4CAF50">üîÑ Retour √† Automatique</button>
      <button class="nav-button cancel-btn" onclick="closeEditModal()" style="background:#f44336;color:white;border:2px solid #f44336">‚ùå Annuler</button>
    </div>
  </div>
</div>

<!-- Modal Nouvelle entr√©e -->
<div id="inputModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:1000">
  <div style="background:#fff3e0;padding:20px;border-radius:10px;width:300px;text-align:right;box-shadow:0 4px 20px rgba(0,0,0,0.2);border:2px solid #000000">
    <h3 style="color:#000000;margin-bottom:15px;">Nouvelle entr√©e</h3>
    <input id="inNumber" placeholder="Num√©ro" style="width:100%;padding:10px;margin-bottom:10px;border:1px solid #000000;border-radius:4px;background:white">
    <input id="inNote" placeholder="Remarque (optionnel)" style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #000000;border-radius:4px;background:white">
    <button class="nav-button" onclick="saveInput()" style="background:#000000;color:white;border:2px solid white">üíæ Sauvegarder</button>
    <button class="nav-button" style="background:#ff9800;color:#000000;border:2px solid #000000" onclick="closeInput()">Annuler</button>
  </div>
</div>

<!-- Modal Excel -->
<div id="excelModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:1000">
  <div style="background:#fff3e0;padding:20px;border-radius:10px;width:350px;text-align:right;box-shadow:0 4px 20px rgba(0,0,0,0.2);border:2px solid #000000">
    <h3 style="color:#000000;margin-bottom:15px;">Exporter Excel</h3>
    <label style="display:block;margin-bottom:10px;color:#000000;">
      <input type="radio" name="excelOption" value="range"> Entre deux dates
    </label>
    <label style="display:block;margin-bottom:15px;color:#000000;">
      <input type="radio" name="excelOption" value="all" checked> Tout
    </label>
    
    <input type="date" id="fromDate" style="width:100%;padding:10px;margin-top:5px;border:1px solid #000000;border-radius:4px;background:white" disabled>
    <input type="date" id="toDate" style="width:100%;padding:10px;margin-top:10px;border:1px solid #000000;border-radius:4px;background:white" disabled>
    <button class="nav-button" onclick="exportExcelWithOption()" style="background:#000000;color:white;border:2px solid white">üíæ Exporter</button>
    <button class="nav-button" style="background:#ff9800;color:#000000;border:2px solid #000000" onclick="closeExcelForm()">Annuler</button>
  </div>
</div>

<!-- Modal Recherche -->
<div id="searchModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:1000">
  <div style="background:#fff3e0;padding:20px;border-radius:10px;width:400px;text-align:right;max-height:80vh;overflow:auto;box-shadow:0 4px 20px rgba(0,0,0,0.2);border:2px solid #000000">
    <h3 style="color:#000000;margin-bottom:15px;">Rechercher un num√©ro</h3>
    <input id="searchNumber" placeholder="Num√©ro √† rechercher" style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #000000;border-radius:4px;background:white">
    <button class="nav-button" onclick="searchNumber()" style="background:#000000;color:white;border:2px solid white">üîç Rechercher</button>
    <button class="nav-button" style="background:#ff9800;color:#000000;border:2px solid #000000" onclick="closeSearchModal()">Fermer</button>
    <div id="searchResults" style="margin-top:15px;text-align:left"></div>
  </div>
</div>

<!-- Modal Shifts Pr√©c√©dents -->
<div id="previousShiftsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:1000">
  <div style="background:#fff3e0;padding:20px;border-radius:10px;width:500px;max-height:80vh;text-align:right;overflow:auto;box-shadow:0 4px 20px rgba(0,0,0,0.2);border:2px solid #000000">
    <h3 style="color:#000000;margin-bottom:15px;text-align:center;">üìú Liste des Shifts Pr√©c√©dents</h3>
    
    <div id="previousShiftsList" style="margin-bottom:15px;max-height:60vh;overflow-y:auto;">
      <!-- Sera rempli avec les shifts pr√©c√©dents -->
    </div>
    
    <div style="text-align:center;">
      <button class="nav-button" style="background:#000000;color:white;border:2px solid white" onclick="closePreviousShiftsModal()">Fermer</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
const table = document.getElementById("dataTable");
const totalCount = document.getElementById("totalCount");
let currentShiftFilter = null;
let currentShiftIndex = -1;
let currentEditingItem = null;
let headerModes = {
  week: 'auto',
  date: 'auto',
  time: 'auto',
  team: 'auto',
  shift: 'auto',
  worker: 'auto'
};

/* ===== UTIL ===== */
function getWeekNumber(d){
  d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
  const day=d.getUTCDay()||7;
  d.setUTCDate(d.getUTCDate()+4-day);
  const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d-yearStart)/86400000)+1)/7);
}

/* ===== Syst√®me de shifts modifi√© selon le jour ===== */
function getCurrentShiftAndTeam(){
  const now = new Date();
  const hour = now.getHours();
  const minutes = now.getMinutes();
  const dayOfWeek = now.getDay(); // 0=Dimanche, 1=Lundi, 2=Mardi, 3=Mercredi, 4=Jeudi, 5=Vendredi, 6=Samedi
  const even = getWeekNumber(now) % 2 === 0;
  
  // Fonction helper pour v√©rifier l'heure
  const isBetween = (startH, startM, endH, endM) => {
    const currentTime = hour * 60 + minutes;
    const startTime = startH * 60 + startM;
    const endTime = endH * 60 + endM;
    return currentTime >= startTime && currentTime < endTime;
  };

  // Tableau des shifts selon le jour
  switch(dayOfWeek) {
    case 5: // Vendredi
      if (isBetween(7, 0, 14, 30)) {
        return {shift: "Matin", team: even ? "B" : "A", worker: even ? "Hind" : "Redouane"};
      } else if (isBetween(14, 30, 15, 15)) {
        return {shift: "Pri√®re du Vendredi", team: "Pause", worker: "Pause"};
      } else if (isBetween(15, 15, 23, 0)) {
        return {shift: "Soir", team: even ? "A" : "B", worker: even ? "Redouane" : "Hind"};
      } else {
        return {shift: "Nuit", team: "--", worker: "--"};
      }
      
    case 6: // Samedi
      if (isBetween(7, 0, 15, 0)) {
        return {shift: "Matin", team: even ? "B" : "A", worker: even ? "Hind" : "Redouane"};
      } else if (isBetween(15, 0, 23, 15)) {
        return {shift: "Soir", team: even ? "A" : "B", worker: even ? "Redouane" : "Hind"};
      } else {
        return {shift: "Nuit", team: "--", worker: "--"};
      }
      
    case 0: // Dimanche
      if (isBetween(7, 0, 15, 0)) {
        return {shift: "Matin", team: even ? "B" : "A", worker: even ? "Hind" : "Redouane"};
      } else if (isBetween(15, 0, 22, 30)) {
        return {shift: "Soir", team: even ? "A" : "B", worker: even ? "Redouane" : "Hind"};
      } else {
        return {shift: "Nuit", team: "--", worker: "--"};
      }
      
    case 1: // Lundi
      if (isBetween(6, 30, 15, 0)) {
        return {shift: "Matin", team: even ? "B" : "A", worker: even ? "Hind" : "Redouane"};
      } else if (isBetween(15, 0, 23, 0)) {
        return {shift: "Soir", team: even ? "A" : "B", worker: even ? "Redouane" : "Hind"};
      } else {
        return {shift: "Nuit", team: "--", worker: "--"};
      }
      
    default: // Mardi √† Jeudi (jours normaux)
      if (isBetween(7, 0, 15, 0)) {
        return {shift: "Matin", team: even ? "B" : "A", worker: even ? "Hind" : "Redouane"};
      } else if (isBetween(15, 0, 23, 0)) {
        return {shift: "Soir", team: even ? "A" : "B", worker: even ? "Redouane" : "Hind"};
      } else {
        return {shift: "Nuit", team: "--", worker: "--"};
      }
  }
}

/* ===== Fonction pour obtenir les horaires des shifts actuels ===== */
function getCurrentShiftSchedule() {
  const now = new Date();
  const dayOfWeek = now.getDay();
  const dayNames = ["Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"];
  const currentDay = dayNames[dayOfWeek];
  
  let schedule = "";
  let showPrayerIndicator = false;
  
  switch(dayOfWeek) {
    case 5: // Vendredi
      schedule = "‚è∞ Vendredi: Matin (07:00-14:30) | Pri√®re du Vendredi (14:30-15:15) | Soir (15:15-23:00)";
      // V√©rifier si on est dans l'heure de pri√®re
      const hour = now.getHours();
      const minutes = now.getMinutes();
      const currentTime = hour * 60 + minutes;
      if (currentTime >= 14*60 + 30 && currentTime < 15*60 + 15) {
        showPrayerIndicator = true;
      }
      break;
      
    case 6: // Samedi
      schedule = "‚è∞ Samedi: Matin (07:00-15:00) | Soir (15:00-23:15) | Nuit (23:15-07:00)";
      break;
      
    case 0: // Dimanche
      schedule = "‚è∞ Dimanche: Matin (07:00-15:00) | Soir (15:00-22:30) | Nuit (22:30-07:00)";
      break;
      
    case 1: // Lundi
      schedule = "‚è∞ Lundi: Matin (06:30-15:00) | Soir (15:00-23:00) | Nuit (23:00-06:30)";
      break;
      
    default: // Mardi √† Jeudi
      schedule = "‚è∞ Jours Normaux: Matin (07:00-15:00) | Soir (15:00-23:00) | Nuit (23:00-07:00)";
      break;
  }
  
  return {
    text: schedule,
    showPrayer: showPrayerIndicator,
    dayName: currentDay
  };
}

/* ===== Mettre √† jour l'indicateur de pri√®re en haut de page ===== */
function updatePrayerIndicator() {
  const schedule = getCurrentShiftSchedule();
  
  if (schedule.showPrayer) {
    let indicator = document.getElementById("prayerIndicator");
    
    if (!indicator) {
      // Cr√©er l'indicateur s'il n'existe pas
      indicator = document.createElement("div");
      indicator.id = "prayerIndicator";
      indicator.innerHTML = "üïå Temps de Pri√®re du Vendredi";
      document.body.appendChild(indicator);
    }
  } else {
    const indicator = document.getElementById("prayerIndicator");
    if (indicator) {
      indicator.remove();
    }
  }
}

/* ===== Syst√®me de gestion des informations d'en-t√™te ===== */
function openEditModal(item) {
  currentEditingItem = item;
  
  const editModal = document.getElementById("editModal");
  const editTitle = document.getElementById("editTitle");
  const currentValueDisplay = document.getElementById("currentValueDisplay");
  const editInput = document.getElementById("editInput");
  
  const labels = {
    'week': 'Modifier la Semaine',
    'date': 'Modifier la Date',
    'time': 'Modifier l\'Heure',
    'team': 'Modifier l\'√âquipe',
    'shift': 'Modifier le Shift',
    'worker': 'Modifier l\'OPS'
  };
  
  const currentValue = document.getElementById(item + "Value").textContent;
  
  editTitle.textContent = labels[item] || 'Modifier la valeur';
  currentValueDisplay.textContent = currentValue;
  editInput.value = currentValue;
  editInput.focus();
  editInput.select();
  
  editModal.style.display = "flex";
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
  document.getElementById("editInput").value = "";
  currentEditingItem = null;
}

function applyChanges(mode) {
  if (!currentEditingItem) return;
  
  const editInput = document.getElementById("editInput");
  const newValue = editInput.value.trim();
  
  if (!newValue) {
    alert("Veuillez entrer une nouvelle valeur");
    return;
  }
  
  // Mettre √† jour la valeur dans l'interface
  document.getElementById(currentEditingItem + "Value").textContent = newValue;
  
  // Mettre √† jour le mode
  headerModes[currentEditingItem] = mode;
  
  // Mettre √† jour l'apparence de l'√©l√©ment
  updateHeaderItemAppearance(currentEditingItem);
  
  // Si le mode est automatique, mettre √† jour la valeur automatiquement
  if (mode === 'auto') {
    updateAutoValue(currentEditingItem);
  }
  
  // Sauvegarder dans localStorage
  saveHeaderInfo();
  
  // Mettre √† jour les informations du shift
  updateShiftInfo();
  
  closeEditModal();
}

function setToAutoMode() {
  if (!currentEditingItem) return;
  
  // D√©finir le mode sur automatique
  headerModes[currentEditingItem] = 'auto';
  
  // Mettre √† jour la valeur automatiquement
  updateAutoValue(currentEditingItem);
  
  // Mettre √† jour l'apparence de l'√©l√©ment
  updateHeaderItemAppearance(currentEditingItem);
  
  // Sauvegarder dans localStorage
  saveHeaderInfo();
  
  // Mettre √† jour les informations du shift
  updateShiftInfo();
  
  closeEditModal();
}

function updateAutoValue(item) {
  const now = new Date();
  const autoShiftInfo = getCurrentShiftAndTeam();
  
  switch(item) {
    case 'week':
      document.getElementById("weekValue").textContent = getWeekNumber(now);
      break;
    case 'date':
      document.getElementById("dateValue").textContent = now.toLocaleDateString('fr-FR');
      break;
    case 'time':
      document.getElementById("timeValue").textContent = now.toLocaleTimeString('fr-FR');
      break;
    case 'team':
      document.getElementById("teamValue").textContent = autoShiftInfo.team;
      break;
    case 'shift':
      document.getElementById("shiftValue").textContent = autoShiftInfo.shift;
      break;
    case 'worker':
      document.getElementById("workerValue").textContent = autoShiftInfo.worker;
      break;
  }
}

function updateHeaderItemAppearance(item) {
  const itemElement = document.getElementById(item + "Item");
  const indicator = itemElement.querySelector('.auto-mode-indicator');
  const mode = headerModes[item];
  
  itemElement.classList.remove("auto-mode", "manual-mode");
  itemElement.classList.add(mode === 'auto' ? "auto-mode" : "manual-mode");
  
  indicator.textContent = mode === 'auto' ? 'A' : 'M';
  indicator.style.background = mode === 'auto' ? '#4CAF50' : '#2196F3';
}

function saveHeaderInfo() {
  const headerInfo = {
    week: document.getElementById("weekValue").textContent,
    date: document.getElementById("dateValue").textContent,
    time: document.getElementById("timeValue").textContent,
    team: document.getElementById("teamValue").textContent,
    shift: document.getElementById("shiftValue").textContent,
    worker: document.getElementById("workerValue").textContent,
    modes: headerModes
  };
  
  localStorage.setItem("headerInfo", JSON.stringify(headerInfo));
}

function loadHeaderInfo() {
  const saved = JSON.parse(localStorage.getItem("headerInfo")) || {};
  const now = new Date();
  const autoShiftInfo = getCurrentShiftAndTeam();
  
  // Charger les modes
  if (saved.modes) {
    headerModes = saved.modes;
  }
  
  // Appliquer les valeurs et modes
  const items = ['week', 'date', 'time', 'team', 'shift', 'worker'];
  items.forEach(item => {
    const valueElement = document.getElementById(item + "Value");
    
    // D√©finir la valeur
    if (saved[item] && headerModes[item] === 'manual') {
      valueElement.textContent = saved[item];
    } else {
      updateAutoValue(item);
    }
    
    // Mettre √† jour l'apparence
    updateHeaderItemAppearance(item);
  });
}

/* ===== Gestion des shifts ===== */
function getCurrentShiftInfo() {
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-FR');
  const auto = getCurrentShiftAndTeam();
  
  // Utiliser les valeurs manuelles si en mode manuel
  return {
    date: headerModes.date === 'manual' ? document.getElementById("dateValue").textContent : dateStr,
    shift: headerModes.shift === 'manual' ? document.getElementById("shiftValue").textContent : auto.shift,
    team: headerModes.team === 'manual' ? document.getElementById("teamValue").textContent : auto.team,
    worker: headerModes.worker === 'manual' ? document.getElementById("workerValue").textContent : auto.worker
  };
}

function updateShiftInfo() {
  const shiftInfo = getCurrentShiftInfo();
  const schedule = getCurrentShiftSchedule();
  
  const shiftInfoDisplay = document.getElementById("shiftInfoDisplay");
  if (shiftInfoDisplay) {
    shiftInfoDisplay.innerHTML = `
      <strong>Jour:</strong> ${schedule.dayName} | 
      <strong>Shift:</strong> ${shiftInfo.shift} | 
      <strong>√âquipe:</strong> ${shiftInfo.team} | 
      <strong>OPS:</strong> ${shiftInfo.worker} | 
      <strong>Date:</strong> ${shiftInfo.date}<br>
      <small style="color:#666;font-size:12px;">${schedule.text}</small>
    `;
  }

  currentShiftFilter = null;
  currentShiftIndex = -1;
  loadData();
  
  // Mettre √† jour l'indicateur de pri√®re
  updatePrayerIndicator();
}

function endCurrentShift() {
  const currentShift = getCurrentShiftInfo();
  const schedule = getCurrentShiftSchedule();
  
  if(confirm("√ätes-vous s√ªr de vouloir terminer le shift actuel ? Le tableau visible sera effac√©, mais les donn√©es resteront dans la base de donn√©es.")) {
    const db = JSON.parse(localStorage.getItem("database") || "[]");
    const currentShiftData = db.filter(e => 
      e.date === currentShift.date &&
      e.shift === currentShift.shift &&
      e.team === currentShift.team &&
      e.worker === currentShift.worker
    );

    const endedShifts = JSON.parse(localStorage.getItem("endedShifts") || "[]");
    
    const shiftId = Date.now();
    
    // Ajouter les informations du jour et du shift aux donn√©es sauvegard√©es
    const shiftToSave = {
      id: shiftId,
      date: currentShift.date,
      day: schedule.dayName,
      shift: currentShift.shift,
      team: currentShift.team,
      worker: currentShift.worker,
      endedAt: new Date().toLocaleTimeString('fr-FR'),
      schedule: schedule.text,
      data: [...currentShiftData]
    };
    
    endedShifts.unshift(shiftToSave);
    localStorage.setItem("endedShifts", JSON.stringify(endedShifts));

    table.innerHTML = "";
    totalCount.textContent = "0";
    currentShiftFilter = null;
    currentShiftIndex = -1;
    
    document.getElementById("shiftInfoDisplay").innerHTML = `
      <strong>Shift Termin√©</strong> - Pr√™t pour nouveau shift<br>
      <small style="color:#666;font-size:12px;">${schedule.text}</small>
    `;
    
    // Supprimer l'indicateur de pri√®re s'il existe
    const indicator = document.getElementById("prayerIndicator");
    if (indicator) {
      indicator.remove();
    }
    
    alert("Shift termin√© avec succ√®s ! Le tableau est maintenant vide et pr√™t pour le prochain shift.");
  }
}

function previousShift() {
  const endedShifts = JSON.parse(localStorage.getItem("endedShifts") || "[]");
  if(endedShifts.length === 0) {
    alert("Aucun shift pr√©c√©dent disponible.");
    return;
  }
  
  if (currentShiftIndex === -1) {
    currentShiftIndex = 0;
  } else if (currentShiftIndex < endedShifts.length - 1) {
    currentShiftIndex++;
  } else {
    alert("C'est le dernier shift disponible dans l'historique.");
    return;
  }
  
  const prevShift = endedShifts[currentShiftIndex];
  currentShiftFilter = prevShift;

  document.getElementById("shiftInfoDisplay").innerHTML = 
    `<strong>Shift Pr√©c√©dent (${currentShiftIndex + 1}/${endedShifts.length}):</strong> ${prevShift.shift} | <strong>√âquipe:</strong> ${prevShift.team} | <strong>OPS:</strong> ${prevShift.worker} | <strong>Date:</strong> ${prevShift.date} (Termin√© √†: ${prevShift.endedAt})<br>
     <small style="color:#666;font-size:12px;">${prevShift.schedule || 'Horaire normal'}</small>`;

  loadData();
}

function nextShift() {
  const endedShifts = JSON.parse(localStorage.getItem("endedShifts") || "[]");
  
  if (currentShiftIndex > 0) {
    currentShiftIndex--;
    const prevShift = endedShifts[currentShiftIndex];
    currentShiftFilter = prevShift;

    document.getElementById("shiftInfoDisplay").innerHTML = 
      `<strong>Shift Pr√©c√©dent (${currentShiftIndex + 1}/${endedShifts.length}):</strong> ${prevShift.shift} | <strong>√âquipe:</strong> ${prevShift.team} | <strong>OPS:</strong> ${prevShift.worker} | <strong>Date:</strong> ${prevShift.date} (Termin√© √†: ${prevShift.endedAt})<br>
       <small style="color:#666;font-size:12px;">${prevShift.schedule || 'Horaire normal'}</small>`;
  } else if (currentShiftIndex === 0) {
    currentShiftIndex = -1;
    currentShiftFilter = null;
    updateShiftInfo();
  } else {
    currentShiftFilter = null;
    currentShiftIndex = -1;
    updateShiftInfo();
  }
  
  loadData();
}

/* ===== Modal Shifts Pr√©c√©dents ===== */
function openPreviousShiftsModal() {
  const endedShifts = JSON.parse(localStorage.getItem("endedShifts") || "[]");
  const listContainer = document.getElementById("previousShiftsList");
  
  if (endedShifts.length === 0) {
    listContainer.innerHTML = "<p style='text-align:center;color:#000000;padding:20px;'>Aucun shift pr√©c√©dent</p>";
  } else {
    let html = "<div style='margin-bottom:10px;'>";
    
    endedShifts.forEach((shift, index) => {
      const teamClass = shift.team === 'A' ? 'team-A' : 'team-B';
      const isActive = currentShiftIndex === index;
      const bgColor = isActive ? '#ffcc80' : '#fff3e0';
      
      html += `
        <div class="previous-shift-item ${teamClass}" 
             onclick="loadShiftFromModal(${index})"
             style="background:${bgColor}">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <strong>${shift.day} - ${shift.shift}</strong><br>
              <small>${shift.date} - √âquipe ${shift.team} - ${shift.worker}</small>
            </div>
            <div style="text-align:left; font-size:12px;">
              ${shift.endedAt}
            </div>
          </div>
          <div style="font-size:11px; color:#666; margin-top:5px;">
            ${shift.schedule || 'Horaire normal'}
          </div>
        </div>
      `;
    });
    
    html += "</div>";
    listContainer.innerHTML = html;
  }
  
  document.getElementById("previousShiftsModal").style.display = "flex";
}

function closePreviousShiftsModal() {
  document.getElementById("previousShiftsModal").style.display = "none";
}

function loadShiftFromModal(index) {
  const endedShifts = JSON.parse(localStorage.getItem("endedShifts") || []);
  if (index >= 0 && index < endedShifts.length) {
    currentShiftIndex = index;
    const shift = endedShifts[index];
    currentShiftFilter = shift;

    document.getElementById("shiftInfoDisplay").innerHTML = 
      `<strong>Shift Pr√©c√©dent (${index + 1}/${endedShifts.length}):</strong> ${shift.shift} | <strong>√âquipe:</strong> ${shift.team} | <strong>OPS:</strong> ${shift.worker} | <strong>Date:</strong> ${shift.date} (Termin√© √†: ${shift.endedAt})<br>
       <small style="color:#666;font-size:12px;">${shift.schedule || 'Horaire normal'}</small>`;

    loadData();
    closePreviousShiftsModal();
  }
}

/* ===== Mettre √† jour l'heure automatiquement ===== */
function updateTime() {
  if (headerModes.time === 'auto') {
    document.getElementById("timeValue").textContent = new Date().toLocaleTimeString('fr-FR');
  }
}

/* ===== ENREGISTREMENT avec accumulation des notes ===== */
function saveInput(){
  const inNumber = document.getElementById("inNumber");
  const inNote = document.getElementById("inNote");
  
  if(!inNumber.value.trim()) return alert("Num√©ro obligatoire");

  let note=inNote.value.trim()||"NE";
  let db=JSON.parse(localStorage.getItem("database")||"[]");

  const existing=db.find(e=>e.number===inNumber.value.trim());

  if(existing){
    if(note!=="NE"){
      if(existing.note && existing.note!=="NE"){
        existing.note += "\n" + note;
      }else{
        existing.note = note;
      }
    }
  }else{
    const now=new Date();
    const currentShift = getCurrentShiftInfo();
    
    db.push({
      week: headerModes.week === 'manual' ? document.getElementById("weekValue").textContent : getWeekNumber(now),
      date: currentShift.date,
      time: headerModes.time === 'manual' ? document.getElementById("timeValue").textContent : now.toLocaleTimeString('fr-FR'),
      team: currentShift.team,
      shift: currentShift.shift,
      worker: currentShift.worker,
      number: inNumber.value.trim(),
      note: note
    });
  }

  localStorage.setItem("database",JSON.stringify(db));
  inNumber.value="";
  inNote.value="";
  closeInput();
  loadData();
}

/* ===== TABLE ===== */
function loadData(){
  const db = JSON.parse(localStorage.getItem("database") || "[]");
  table.innerHTML = "";

  let filteredData = db;

  if (currentShiftFilter) {
    filteredData = currentShiftFilter.data || [];
  } else {
    const nowShift = getCurrentShiftInfo();
    filteredData = db.filter(e =>
      e.date === nowShift.date &&
      e.shift === nowShift.shift &&
      e.team === nowShift.team &&
      e.worker === nowShift.worker
    );
  }

  totalCount.textContent = filteredData.length;

  filteredData.forEach((e, i) => {
    const realIndex = db.findIndex(item => 
      item.date === e.date &&
      item.time === e.time &&
      item.number === e.number
    );
    
    table.innerHTML += `
    <tr>
      <td>${e.time}</td>
      <td>${e.number}</td>
      <td>${e.note}</td>
      <td><button onclick="deleteRow(${realIndex})" style="background:#000000;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;border:1px solid white">üóëÔ∏è</button></td>
    </tr>`;
  });
}

/* ===== Supprimer une ligne ===== */
function deleteRow(i){
  if(prompt("Code suppression ?")!=="1234") return;
  let db=JSON.parse(localStorage.getItem("database")||"[]");
  db.splice(i,1);
  localStorage.setItem("database",JSON.stringify(db));
  loadData();
}

/* ===== G√©n√©rer PDF format√© ===== */
function generateFormattedPDF() {
  // Obtenir toutes les lignes du tableau affich√©
  const tableRows = table.querySelectorAll('tr');
  
  // V√©rifier s'il y a des donn√©es
  if (tableRows.length === 0) {
    alert("Aucune donn√©e dans le tableau √† exporter!");
    return;
  }
  
  // Collecter les donn√©es du tableau
  const tableData = [];
  
  // Ajouter les en-t√™tes du tableau
  const headers = ['Heure', 'Num√©ro', 'Remarque'];
  tableData.push(headers);
  
  // Ajouter les donn√©es des lignes
  tableRows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length >= 3) {
      const rowData = [
        cells[0].textContent, // Heure
        cells[1].textContent, // Num√©ro
        cells[2].textContent  // Remarque
      ];
      tableData.push(rowData);
    }
  });
  
  // Obtenir les informations de l'en-t√™te
  const headerInfo = {
    semaine: document.getElementById("weekValue").textContent,
    date: document.getElementById("dateValue").textContent,
    heure: document.getElementById("timeValue").textContent,
    √©quipe: document.getElementById("teamValue").textContent,
    shift: document.getElementById("shiftValue").textContent,
    OPS: document.getElementById("workerValue").textContent
  };
  
  const totalProducts = totalCount.textContent;
  
  // Cr√©er un nouveau PDF
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');
  
  // Param√®tres de la page
  const pageWidth = 210;
  const pageHeight = 297;
  const margin = 15;
  const lineHeight = 7;
  let yPos = margin;
  
  // Fonction pour ajouter une nouvelle page
  const addNewPage = () => {
    pdf.addPage();
    yPos = margin;
    
    // R√©√©crire le titre sur la nouvelle page
    pdf.setFontSize(20);
    pdf.setFont("helvetica", "bold");
    pdf.text("SUIVI PRODUCTION MOBILISE", pageWidth / 2, yPos, { align: 'center' });
    yPos += 15;
    
    return yPos;
  };
  
  // Titre principal
  pdf.setFontSize(20);
  pdf.setFont("helvetica", "bold");
  pdf.text("SUIVI PRODUCTION MOBILISE", pageWidth / 2, yPos, { align: 'center' });
  yPos += 15;
  
  // Informations de l'en-t√™te (sans informations du jour ni horaires)
  pdf.setFontSize(11);
  pdf.setFont("helvetica", "normal");
  
  const headerInfoText = [
    `Semaine: ${headerInfo.semaine} | Date: ${headerInfo.date} | Heure: ${headerInfo.heure}`,
    `√âquipe: ${headerInfo.√©quipe} | Shift: ${headerInfo.shift} | OPS: ${headerInfo.OPS}`
  ];
  
  headerInfoText.forEach(line => {
    pdf.text(line, pageWidth / 2, yPos, { align: 'center' });
    yPos += lineHeight;
  });
  
  yPos += 5;
  
  // Total
  pdf.setFont("helvetica", "bold");
  pdf.text(`Total produits: ${totalProducts}`, pageWidth / 2, yPos, { align: 'center' });
  yPos += 10;
  
  // Pr√©parer le tableau
  const tableTop = yPos;
  const cellWidth = (pageWidth - 2 * margin) / 3;
  const cellHeight = 8;
  
  // En-t√™te du tableau
  pdf.setFillColor(0, 0, 0);
  pdf.setTextColor(255, 255, 255);
  pdf.setFont("helvetica", "bold");
  
  // Dessiner les cellules d'en-t√™te
  pdf.rect(margin, tableTop, cellWidth, cellHeight, 'F');
  pdf.rect(margin + cellWidth, tableTop, cellWidth, cellHeight, 'F');
  pdf.rect(margin + cellWidth * 2, tableTop, cellWidth, cellHeight, 'F');
  
  // √âcrire les en-t√™tes du tableau
  pdf.text(headers[0], margin + cellWidth / 2, tableTop + cellHeight / 2 + 2, { align: 'center' });
  pdf.text(headers[1], margin + cellWidth * 1.5, tableTop + cellHeight / 2 + 2, { align: 'center' });
  pdf.text(headers[2], margin + cellWidth * 2.5, tableTop + cellHeight / 2 + 2, { align: 'center' });
  
  yPos = tableTop + cellHeight;
  
  // Donn√©es du tableau
  pdf.setTextColor(0, 0, 0);
  pdf.setFont("helvetica", "normal");
  
  let currentPageRow = 0;
  const maxRowsPerPage = Math.floor((pageHeight - yPos - margin) / cellHeight) - 1;
  
  // Commencer √† partir de la deuxi√®me ligne (ignorer les en-t√™tes)
  for (let i = 1; i < tableData.length; i++) {
    // V√©rifier si nous avons besoin d'une nouvelle page
    if (currentPageRow >= maxRowsPerPage) {
      yPos = addNewPage();
      
      // Redessiner l'en-t√™te du tableau sur la nouvelle page
      pdf.setFillColor(0, 0, 0);
      pdf.setTextColor(255, 255, 255);
      pdf.setFont("helvetica", "bold");
      
      pdf.rect(margin, yPos, cellWidth, cellHeight, 'F');
      pdf.rect(margin + cellWidth, yPos, cellWidth, cellHeight, 'F');
      pdf.rect(margin + cellWidth * 2, yPos, cellWidth, cellHeight, 'F');
      
      pdf.text(headers[0], margin + cellWidth / 2, yPos + cellHeight / 2 + 2, { align: 'center' });
      pdf.text(headers[1], margin + cellWidth * 1.5, yPos + cellHeight / 2 + 2, { align: 'center' });
      pdf.text(headers[2], margin + cellWidth * 2.5, yPos + cellHeight / 2 + 2, { align: 'center' });
      
      yPos += cellHeight;
      currentPageRow = 0;
      
      pdf.setTextColor(0, 0, 0);
      pdf.setFont("helvetica", "normal");
    }
    
    const row = tableData[i];
    
    // Dessiner un arri√®re-plan altern√© pour les lignes
    if (currentPageRow % 2 === 0) {
      pdf.setFillColor(240, 240, 240);
      pdf.rect(margin, yPos, cellWidth * 3, cellHeight, 'F');
    }
    
    // Bordures des cellules
    pdf.setDrawColor(0, 0, 0);
    pdf.rect(margin, yPos, cellWidth, cellHeight);
    pdf.rect(margin + cellWidth, yPos, cellWidth, cellHeight);
    pdf.rect(margin + cellWidth * 2, yPos, cellWidth, cellHeight);
    
    // √âcrire les donn√©es - Premi√®re colonne (Heure)
    const heureText = row[0] || '';
    pdf.text(heureText, margin + cellWidth / 2, yPos + cellHeight / 2 + 2, { align: 'center' });
    
    // √âcrire les donn√©es - Deuxi√®me colonne (Num√©ro)
    const numeroText = row[1] || '';
    pdf.text(numeroText, margin + cellWidth * 1.5, yPos + cellHeight / 2 + 2, { align: 'center' });
    
    // √âcrire les donn√©es - Troisi√®me colonne (Remarques)
    const noteText = row[2] || '';
    
    // G√©rer les remarques longues
    if (noteText.length > 25) {
      // Diviser les remarques longues
      const words = noteText.split(' ');
      let currentLine = '';
      let lines = [];
      
      for (const word of words) {
        if ((currentLine + word).length > 25) {
          lines.push(currentLine);
          currentLine = word + ' ';
        } else {
          currentLine += word + ' ';
        }
      }
      if (currentLine) lines.push(currentLine.trim());
      
      // √âcrire la premi√®re ligne
      if (lines[0]) {
        pdf.text(lines[0], margin + cellWidth * 2.5, yPos + cellHeight / 2 + 2, { align: 'center' });
      }
      
      // S'il y a des lignes suppl√©mentaires, augmenter la hauteur de la cellule
      if (lines.length > 1) {
        const extraHeight = (lines.length - 1) * 4;
        pdf.rect(margin + cellWidth * 2, yPos, cellWidth, cellHeight + extraHeight);
        
        // √âcrire les lignes suppl√©mentaires
        for (let j = 1; j < lines.length; j++) {
          if (lines[j]) {
            pdf.text(lines[j], margin + cellWidth * 2.5, yPos + cellHeight / 2 + 2 + (j * 4), { align: 'center' });
          }
        }
        
        // Ajuster les bordures des cellules adjacentes
        pdf.rect(margin, yPos, cellWidth, cellHeight + extraHeight);
        pdf.rect(margin + cellWidth, yPos, cellWidth, cellHeight + extraHeight);
        
        yPos += cellHeight + extraHeight;
      } else {
        yPos += cellHeight;
      }
    } else {
      // Remarques courtes
      pdf.text(noteText, margin + cellWidth * 2.5, yPos + cellHeight / 2 + 2, { align: 'center' });
      yPos += cellHeight;
    }
    
    currentPageRow++;
  }
  
  // Pied de page de la derni√®re page
  yPos = Math.max(yPos, pageHeight - margin);
  pdf.setFontSize(10);
  pdf.setFont("helvetica", "italic");
  pdf.setTextColor(100, 100, 100);
  pdf.text(`Document g√©n√©r√© le: ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}`, pageWidth / 2, yPos, { align: 'center' });
  
  // Sauvegarder PDF
  const fileName = `Production_${headerInfo.date.replace(/\//g, '-')}_${headerInfo.shift}_${headerInfo.√©quipe}.pdf`;
  pdf.save(fileName);
  
  alert(`PDF g√©n√©r√© avec succ√®s! ${tableData.length - 1} entr√©es export√©es.`);
}

function exportAndClearVisiblePDF() {
  generateFormattedPDF();
  
  // Effacer le tableau apr√®s la cr√©ation du PDF
  setTimeout(() => {
    table.innerHTML = "";
    totalCount.textContent = "0";
  }, 1000);
}

/* ===== MODAL entr√©e ===== */
function openInput(){
  document.getElementById("inputModal").style.display="flex";
}
function closeInput(){ 
  document.getElementById("inputModal").style.display="none";
}

/* ===== Excel ===== */
function openExcelForm(){ document.getElementById("excelModal").style.display="flex"; }
function closeExcelForm(){ document.getElementById("excelModal").style.display="none"; }

document.querySelectorAll('input[name="excelOption"]').forEach(radio=>{
  radio.addEventListener("change",()=>{
    if(radio.value==="range" && radio.checked){
      document.getElementById("fromDate").disabled=false;
      document.getElementById("toDate").disabled=false;
    }else{
      document.getElementById("fromDate").disabled=true;
      document.getElementById("toDate").disabled=true;
    }
  });
});

function exportExcelWithOption(){
  const db=JSON.parse(localStorage.getItem("database")||"[]");
  if(!db.length) return alert("Pas de donn√©es");

  const option = document.querySelector('input[name="excelOption"]:checked').value;
  let filtered=db;

  if(option==="range"){
    const from = new Date(document.getElementById("fromDate").value);
    const to = new Date(document.getElementById("toDate").value);
    if(!document.getElementById("fromDate").value || !document.getElementById("toDate").value) return alert("Veuillez choisir les deux dates");
    filtered = db.filter(e=>{
      const d=new Date(e.date.split('/').reverse().join('-'));
      return d>=from && d<=to;
    });
  }

  const data=[["Semaine","Date","Heure","√âquipe","Shift","OPS","Num√©ro","Remarque"]];
  filtered.forEach(e=>data.push([e.week,e.date,e.time,e.team,e.shift,e.worker,e.number,e.note]));

  const ws=XLSX.utils.aoa_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Production");
  XLSX.writeFile(wb,"production.xlsx");

  closeExcelForm();
}

/* ===== MODAL recherche ===== */
function openSearchModal(){ 
  document.getElementById("searchModal").style.display="flex"; 
  document.getElementById("searchResults").innerHTML = "";
}
function closeSearchModal(){ document.getElementById("searchModal").style.display="none"; }

function searchNumber(){
  const num = document.getElementById("searchNumber").value.trim();
  if(!num) return alert("Veuillez entrer un num√©ro");

  const db = JSON.parse(localStorage.getItem("database")||"[]");
  const results = db.filter(e=>e.number===num);

  const resultsDiv = document.getElementById("searchResults");
  resultsDiv.innerHTML = "";

  if(results.length===0){
    resultsDiv.innerHTML = "<b>Aucune donn√©e trouv√©e pour ce num√©ro.</b>";
    return;
  }

  results.forEach((e,i)=>{
    const html = `
      <div style="border:1px solid #000000;padding:10px;margin-bottom:10px;border-radius:4px;background:#fff3e0">
        <b style="color:#000">Semaine:</b> ${e.week} <br>
        <b style="color:#000">Date:</b> ${e.date} <br>
        <b style="color:#000">Heure:</b> ${e.time} <br>
        <b style="color:#000">√âquipe:</b> ${e.team} <br>
        <b style="color:#000">Shift:</b> ${e.shift} <br>
        <b style="color:#000">OPS:</b> ${e.worker} <br>
        <b style="color:#000">Num√©ro:</b> ${e.number} <br>
        <b style="color:#000">Remarque:</b> ${e.note}
      </div>
    `;
    resultsDiv.innerHTML += html;
  });
}

window.onload=()=>{
  loadHeaderInfo();
  updateShiftInfo();
  loadData();
  setInterval(updateTime, 1000);
  setInterval(updatePrayerIndicator, 60000); // V√©rifier toutes les minutes
};
</script>

</body>
</html>
